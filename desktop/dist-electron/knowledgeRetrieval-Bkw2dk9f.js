"use strict";Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const P=require("fs/promises"),T=require("path");function j(s){const r=Object.create(null,{[Symbol.toStringTag]:{value:"Module"}});if(s){for(const t in s)if(t!=="default"){const n=Object.getOwnPropertyDescriptor(s,t);Object.defineProperty(r,t,n.get?n:{enumerable:!0,get:()=>s[t]})}}return r.default=s,Object.freeze(r)}const A=j(P),_=j(T);function m(s){const t=s.toLowerCase().replace(/[^\u4e00-\u9fa5a-z0-9\s]/g," ").split(/\s+/).filter(e=>e.length>0),n=[];for(let e=0;e<t.length-1;e++)n.push(`${t[e]}${t[e+1]}`);return[...t,...n]}function R(s,r,t,n=1.5,e=.75){const c=r.length,o=new Map;for(const l of r)o.set(l,(o.get(l)||0)+1);let u=0;for(const l of s){const d=o.get(l)||0;if(d>0){const f=d*(n+1),y=d+n*(1-e+e*(c/t));u+=f/y}}return u}function q(s,r){if(s.length!==r.length||s.length===0)return 0;let t=0,n=0,e=0;for(let o=0;o<s.length;o++)t+=s[o]*r[o],n+=s[o]*s[o],e+=r[o]*r[o];const c=Math.sqrt(n)*Math.sqrt(e);return c===0?0:t/c}function E(s,r,t=500,n=100){const e=[],c=s.split(/\n\n+/).filter(l=>l.trim().length>0);let o="",u=0;for(const l of c)o.length+l.length>t&&o.length>0?(e.push({id:`${r}_chunk_${u}`,content:o.trim(),source:r,tokens:m(o)}),u++,o=o.split("").slice(-n).join("")+`

`+l):o+=(o?`

`:"")+l;return o.trim()&&e.push({id:`${r}_chunk_${u}`,content:o.trim(),source:r,tokens:m(o)}),e}function M(s){const r=m(s),t=[...r],n={小红书:["红薯","笔记","种草"],爆款:["热门","火爆","流行","出圈"],涨粉:["增粉","吸粉","粉丝增长"],流量:["曝光","播放量","阅读量","热度"],运营:["营销","推广","增长"],标题:["题目","封面文案","标题党"],内容:["文案","正文","笔记内容"],变现:["赚钱","收益","变现","商业化"],选题:["话题","内容方向","创意"]};for(const e of r){const c=n[e];c&&t.push(...c)}return[...new Set(t)]}async function z(s,r){var t,n;try{const e=await fetch(`${r.endpoint}/embeddings`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${r.apiKey}`},body:JSON.stringify({model:r.model,input:s.slice(0,8e3)})});return e.ok?((n=(t=(await e.json()).data)==null?void 0:t[0])==null?void 0:n.embedding)||null:(console.error("Embedding API error:",e.status),null)}catch(e){return console.error("Embedding request failed:",e),null}}async function B(s,r){var t;try{const n=await fetch(`${r.endpoint}/embeddings`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${r.apiKey}`},body:JSON.stringify({model:r.model,input:s.map(c=>c.slice(0,8e3))})});return n.ok?((t=(await n.json()).data)==null?void 0:t.map(c=>c.embedding))||s.map(()=>null):(console.error("Batch embedding API error:",n.status),s.map(()=>null))}catch(n){return console.error("Batch embedding request failed:",n),s.map(()=>null)}}function G(s,r=60){const t=new Map;for(const n of s)for(let e=0;e<n.length;e++){const c=n[e],o=1/(r+e+1);t.has(c.id)?t.get(c.id).score+=o:t.set(c.id,{chunk:c,score:o})}return Array.from(t.values()).sort((n,e)=>e.score-n.score).map(n=>n.chunk)}async function x(s,r,t,n=3){try{const c=(await A.readdir(r)).filter(a=>a.endsWith(".txt")||a.endsWith(".md"));if(c.length===0)return{chunks:[],context:"",sources:[],method:"keyword-only"};const o=[];for(const a of c){const i=await A.readFile(_.join(r,a),"utf-8"),w=E(i,a);o.push(...w)}if(o.length===0)return{chunks:[],context:"",sources:[],method:"keyword-only"};const u=M(s),l=m(s),d=o.reduce((a,i)=>a+i.tokens.length,0)/o.length,f=o.map(a=>({...a,score:R(l,a.tokens,d)})).sort((a,i)=>(i.score||0)-(a.score||0)),y=o.map(a=>({...a,score:R(u,a.tokens,d)})).sort((a,i)=>(i.score||0)-(a.score||0));let k=[],S="keyword-only";if(t!=null&&t.endpoint&&(t!=null&&t.apiKey)&&(t!=null&&t.model)){console.log("[RAG] Using hybrid search with embeddings"),S="hybrid";const a=await z(s,t);if(a){const i=o.slice(0,Math.min(20,o.length)),w=i.map(h=>h.content),b=await B(w,t);k=i.map((h,p)=>({...h,embedding:b[p]||void 0,score:b[p]?q(a,b[p]):0})).sort((h,p)=>(p.score||0)-(h.score||0))}}else console.log("[RAG] Using keyword-only search (no embedding config)");const $=[f.slice(0,n*2),y.slice(0,n*2)];k.length>0&&$.push(k.slice(0,n*2));const g=G($).slice(0,n),v=[...new Set(g.map(a=>a.source))],O=g.map((a,i)=>`[参考${i+1} - ${a.source}]
${a.content}`).join(`

---

`);return{chunks:g,context:O,sources:v,method:S}}catch(e){return console.error("RAG retrieval failed:",e),{chunks:[],context:"",sources:[],method:"keyword-only"}}}async function F(s,r,t,n){const e=await x(r,t,n,3);let c=s;return e.context&&(c+=`

## 参考知识库 (${e.method==="hybrid"?"混合检索":"关键词检索"})

以下是与用户问题相关的知识内容，请在回答时参考这些信息：

${e.context}`),c+=`

## 回复要求
- 你是群聊中的一员，请根据你的角色设定发表观点
- 保持简洁，200字以内
- 如果知识库中有相关信息，请自然地融入你的回答`,{prompt:c,sources:e.sources,method:e.method}}exports.buildAdvisorPromptWithRAG=F;exports.hybridRetrieve=x;
