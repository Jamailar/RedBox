"use strict";Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const E=require("fs/promises"),M=require("path");function P(r){const s=Object.create(null,{[Symbol.toStringTag]:{value:"Module"}});if(r){for(const e in r)if(e!=="default"){const o=Object.getOwnPropertyDescriptor(r,e);Object.defineProperty(s,e,o.get?o:{enumerable:!0,get:()=>r[e]})}}return s.default=r,Object.freeze(s)}const A=P(E),O=P(M);function S(r){const e=r.toLowerCase().replace(/[^\u4e00-\u9fa5a-z0-9\s]/g," ").split(/\s+/).filter(n=>n.length>0),o=[];for(let n=0;n<e.length-1;n++)o.push(`${e[n]}${e[n+1]}`);return[...e,...o]}function R(r,s,e,o=1.5,n=.75){const l=s.length,t=new Map;for(const u of s)t.set(u,(t.get(u)||0)+1);let h=0;for(const u of r){const f=t.get(u)||0;if(f>0){const y=f*(o+1),g=f+o*(1-n+n*(l/e));h+=y/g}}return h}function v(r,s){if(r.length!==s.length||r.length===0)return 0;let e=0,o=0,n=0;for(let t=0;t<r.length;t++)e+=r[t]*s[t],o+=r[t]*r[t],n+=s[t]*s[t];const l=Math.sqrt(o)*Math.sqrt(n);return l===0?0:e/l}function F(r,s,e=500,o=100){const n=[],l=r.split(/\n\n+/).filter(u=>u.trim().length>0);let t="",h=0;for(const u of l)t.length+u.length>e&&t.length>0?(n.push({id:`${s}_chunk_${h}`,content:t.trim(),source:s,tokens:S(t)}),h++,t=t.split("").slice(-o).join("")+`

`+u):t+=(t?`

`:"")+u;return t.trim()&&n.push({id:`${s}_chunk_${h}`,content:t.trim(),source:s,tokens:S(t)}),n}function L(r){const s=S(r),e=[...s],o={小红书:["红薯","笔记","种草"],爆款:["热门","火爆","流行","出圈"],涨粉:["增粉","吸粉","粉丝增长"],流量:["曝光","播放量","阅读量","热度"],运营:["营销","推广","增长"],标题:["题目","封面文案","标题党"],内容:["文案","正文","笔记内容"],变现:["赚钱","收益","变现","商业化"],选题:["话题","内容方向","创意"]};for(const n of s){const l=o[n];l&&e.push(...l)}return[...new Set(e)]}async function z(r,s){var e,o;try{const n=await fetch(`${s.endpoint}/embeddings`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${s.apiKey}`},body:JSON.stringify({model:s.model,input:r.slice(0,8e3)})});return n.ok?((o=(e=(await n.json()).data)==null?void 0:e[0])==null?void 0:o.embedding)||null:(console.error("Embedding API error:",n.status),null)}catch(n){return console.error("Embedding request failed:",n),null}}async function B(r,s){var e;try{const o=await fetch(`${s.endpoint}/embeddings`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${s.apiKey}`},body:JSON.stringify({model:s.model,input:r.map(l=>l.slice(0,8e3))})});return o.ok?((e=(await o.json()).data)==null?void 0:e.map(l=>l.embedding))||r.map(()=>null):(console.error("Batch embedding API error:",o.status),r.map(()=>null))}catch(o){return console.error("Batch embedding request failed:",o),r.map(()=>null)}}function N(r,s=60){const e=new Map;for(const o of r)for(let n=0;n<o.length;n++){const l=o[n],t=1/(s+n+1);e.has(l.id)?e.get(l.id).score+=t:e.set(l.id,{chunk:l,score:t})}return Array.from(e.values()).sort((o,n)=>n.score-o.score).map(o=>o.chunk)}async function T(r,s,e,o=3){try{const l=(await A.readdir(s)).filter(c=>c.endsWith(".txt")||c.endsWith(".md"));if(l.length===0)return{chunks:[],context:"",sources:[],method:"keyword-only"};const t=[];for(const c of l){const i=await A.readFile(O.join(s,c),"utf-8"),d=F(i,c);t.push(...d)}if(t.length===0)return{chunks:[],context:"",sources:[],method:"keyword-only"};const h=L(r),u=S(r),f=t.reduce((c,i)=>c+i.tokens.length,0)/t.length,y=t.map(c=>({...c,score:R(u,c.tokens,f)})).sort((c,i)=>(i.score||0)-(c.score||0)),g=t.map(c=>({...c,score:R(h,c.tokens,f)})).sort((c,i)=>(i.score||0)-(c.score||0));let w=[],$="keyword-only",m=null;const _=O.join(s,"embeddings.json");try{const c=await A.readFile(_,"utf-8"),i=JSON.parse(c);i.chunks&&i.chunks.length>0&&(console.log("[RAG] Loaded offline index with",i.chunks.length,"chunks"),m=i.chunks)}catch{}if(m){t.length=0,t.push(...m);const c=t.reduce((a,p)=>a+p.tokens.length,0)/t.length,i=t.map(a=>({...a,score:R(u,a.tokens,c)})).sort((a,p)=>(p.score||0)-(a.score||0)),d=t.map(a=>({...a,score:R(h,a.tokens,c)})).sort((a,p)=>(p.score||0)-(a.score||0));y.length=0,y.push(...i),g.length=0,g.push(...d)}if(e!=null&&e.endpoint&&(e!=null&&e.apiKey)&&(e!=null&&e.model)){console.log("[RAG] Using hybrid search with embeddings"),$="hybrid";const c=await z(r,e);if(c)if(m&&m.some(i=>i.embedding))console.log("[RAG] Using offline embeddings for semantic search"),w=m.filter(d=>d.embedding).map(d=>({...d,score:v(c,d.embedding)})).sort((d,a)=>a.score-d.score).slice(0,20);else{console.log("[RAG] No offline embeddings, calculating on-the-fly");const i=t.slice(0,Math.min(20,t.length)),d=i.map(k=>k.content),a=await B(d,e);w=i.map((k,b)=>({...k,embedding:a[b]||void 0,score:a[b]?v(c,a[b]):0})).sort((k,b)=>(b.score||0)-(k.score||0))}}else console.log("[RAG] Using keyword-only search (no embedding config)");const j=[y.slice(0,o*2),g.slice(0,o*2)];w.length>0&&j.push(w.slice(0,o*2));const x=N(j).slice(0,o),q=[...new Set(x.map(c=>c.source))],G=x.map((c,i)=>`[参考${i+1} - ${c.source}]
${c.content}`).join(`

---

`);return{chunks:x,context:G,sources:q,method:$}}catch(n){return console.error("RAG retrieval failed:",n),{chunks:[],context:"",sources:[],method:"keyword-only"}}}async function W(r,s,e,o){const n=await T(s,e,o,3);let l=r;return n.context&&(l+=`

## 参考知识库 (${n.method==="hybrid"?"混合检索":"关键词检索"})

以下是与用户问题相关的知识内容，请在回答时参考这些信息：

${n.context}`),l+=`

## 回复要求
- 你是群聊中的一员，请根据你的角色设定发表观点
- 保持简洁，200字以内
- 如果知识库中有相关信息，请自然地融入你的回答`,{prompt:l,sources:n.sources,method:n.method}}exports.buildAdvisorPromptWithRAG=W;exports.hybridRetrieve=T;
