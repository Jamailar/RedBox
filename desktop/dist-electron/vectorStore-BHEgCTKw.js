"use strict";Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const _=require("fs/promises"),$=require("path");function C(e){const s=Object.create(null,{[Symbol.toStringTag]:{value:"Module"}});if(e){for(const t in e)if(t!=="default"){const n=Object.getOwnPropertyDescriptor(e,t);Object.defineProperty(s,t,n.get?n:{enumerable:!0,get:()=>e[t]})}}return s.default=e,Object.freeze(s)}const g=C(_),b=C($);function O(e){const t=e.toLowerCase().replace(/[^\u4e00-\u9fa5a-z0-9\s]/g," ").split(/\s+/).filter(o=>o.length>0),n=[];for(let o=0;o<t.length-1;o++)n.push(`${t[o]}${t[o+1]}`);return[...t,...n]}function P(e,s,t,n=500,o=100){const c=[],l=e.split(/\n\n+/).filter(r=>r.trim().length>0);let i="",a=0;for(const r of l)i.length+r.length>n&&i.length>0?(c.push({id:`${s}_chunk_${a}`,content:i.trim(),source:s,tokens:O(i),lastModified:t}),a++,i=i.split("").slice(-o).join("")+`

`+r):i+=(i?`

`:"")+r;return i.trim()&&c.push({id:`${s}_chunk_${a}`,content:i.trim(),source:s,tokens:O(i),lastModified:t}),c}async function T(e,s){var t;try{const n=await fetch(`${s.endpoint}/embeddings`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${s.apiKey}`},body:JSON.stringify({model:s.model,input:e.map(c=>c.slice(0,8e3))})});return n.ok?((t=(await n.json()).data)==null?void 0:t.map(c=>c.embedding))||e.map(()=>null):(console.error("VectorStore Embedding API error:",n.status),e.map(()=>null))}catch(n){return console.error("VectorStore embedding request failed:",n),e.map(()=>null)}}async function M(e,s,t,n){const o=b.join(s,e,"knowledge"),c=b.join(s,e,"knowledge","embeddings.json");let l={version:1,lastUpdated:"",chunks:[]};try{const a=await g.readFile(c,"utf-8");l=JSON.parse(a)}catch{}const i=(a,r,h)=>{n==null||n.webContents.send("advisors:indexing-progress",{advisorId:e,current:a,total:r,status:h})};try{const r=(await g.readdir(o)).filter(d=>d.endsWith(".txt")||d.endsWith(".md"));i(0,r.length,"Scanning files...");let h=[];for(let d=0;d<r.length;d++){const p=r[d],S=b.join(o,p),j=(await g.stat(S)).mtimeMs,k=l.chunks.filter(f=>f.source===p);if(!(k.length===0||k.some(f=>(f.lastModified||0)<j)))h.push(...k);else{i(d,r.length,`Processing ${p}...`);const f=await g.readFile(S,"utf-8"),w=P(f,p,j),y=w.map(u=>u.content);if(y.length>0)for(let u=0;u<y.length;u+=10){const x=y.slice(u,u+10),F=await T(x,t);for(let m=0;m<x.length;m++)w[u+m].embedding=F[m]||void 0}h.push(...w)}}return l.chunks=h,l.lastUpdated=new Date().toISOString(),await g.writeFile(c,JSON.stringify(l,null,2)),i(r.length,r.length,"Completed"),l}catch(a){throw console.error("Build index failed:",a),i(0,0,"Error: "+String(a)),a}}async function z(e,s){const t=b.join(s,e,"knowledge","embeddings.json");try{const n=await g.readFile(t,"utf-8"),o=JSON.parse(n);return{indexedFiles:new Set(o.chunks.map(l=>l.source)).size,totalChunks:o.chunks.length,lastUpdated:o.lastUpdated}}catch{return null}}exports.buildVectorIndex=M;exports.getIndexStatus=z;
